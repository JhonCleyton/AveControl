{% extends "base.html" %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
{% endblock extra_css %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Nova Carga</h2>
    
    <form id="formCarga">
        <!-- Informações Básicas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Informações Básicas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="numero_carga" class="form-label">Número da Carga</label>
                            <input type="text" class="form-control" id="numero_carga" readonly required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="tipo_ave" class="form-label">Tipo de Ave</label>
                            <select class="form-select" id="tipo_ave">
                                <option value="">Selecione...</option>
                                <option value="Frango">Frango</option>
                                <option value="Galinha Leve">Galinha Leve</option>
                                <option value="Galinha Matriz">Galinha Matriz</option>
                                <option value="Galinha Vermelha">Galinha Vermelha</option>
                                <option value="Galo">Galo</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="quantidade_cargas" class="form-label">Quantidade de Cargas</label>
                            <input type="number" class="form-control" id="quantidade_cargas">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="ordem_carga" class="form-label">Ordem de Carga</label>
                            <input type="text" class="form-control" id="ordem_carga">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="data_abate" class="form-label">Data de Abate</label>
                            <input type="date" class="form-control" id="data_abate">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="dia_semana" class="form-label">Dia da Semana</label>
                            <input type="text" class="form-control" id="dia_semana" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="agenciador" class="form-label">Agenciador</label>
                            <select class="form-select" id="agenciador">
                                <option value="">Selecione...</option>
                                <option value="Neguinho">Neguinho</option>
                                <option value="Alberto">Alberto</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Informações do Transporte -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Informações do Transporte</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="motorista" class="form-label">Motorista</label>
                            <select class="form-select" id="motorista">
                                <option value="">Selecione...</option>
                                {% for motorista in motoristas %}
                                <option value="{{ motorista }}">{{ motorista }}</option>
                                {% endfor %}
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3" id="outro-motorista-div" style="display: none;">
                            <label for="motorista_outro" class="form-label">Outro Motorista</label>
                            <input type="text" class="form-control" id="motorista_outro">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="transportadora" class="form-label">Transportadora</label>
                            <select class="form-select" id="transportadora">
                                <option value="">Selecione...</option>
                                <option value="Ellen Transportes">Ellen Transportes</option>
                                <option value="Terceirizado">Terceirizado</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="placa_veiculo" class="form-label">Placa do Veículo</label>
                            <select class="form-select" id="placa_veiculo" style="display: none;">
                                <option value="">Selecione...</option>
                                <option value="AZT-7A23" data-valor="6.00">AZT-7A23</option>
                                <option value="HMV-9126" data-valor="6.00">HMV-9126</option>
                                <option value="MYY-8770" data-valor="6.00">MYY-8770</option>
                                <option value="PAM-9J75" data-valor="6.00">PAM-9J75</option>
                                <option value="PIW-6G46" data-valor="6.20">PIW-6G46</option>
                                <option value="QKC-1E87" data-valor="6.00">QKC-1E87</option>
                                <option value="RCY-3D00" data-valor="6.20">RCY-3D00</option>
                                <option value="RLS-3A83" data-valor="6.20">RLS-3A83</option>
                                <option value="RLV-0F19" data-valor="6.20">RLV-0F19</option>
                                <option value="SKP-4J09" data-valor="6.20">SKP-4J09</option>
                                <option value="outra">Outra</option>
                            </select>
                            <input type="text" class="form-control" id="placa_veiculo_input" style="display: none;">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="km_saida" class="form-label">KM Saída</label>
                            <input type="number" class="form-control" id="km_saida" name="km_saida" step="0.01">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="km_chegada" class="form-label">KM Chegada</label>
                            <input type="number" class="form-control" id="km_chegada" name="km_chegada" step="0.01">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="km_rodados" class="form-label">KM Rodados</label>
                            <input type="number" class="form-control" id="km_rodados" name="km_rodados" step="0.01" readonly>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="caixas_vazias" class="form-label">Caixas Vazias</label>
                            <input type="number" class="form-control" id="caixas_vazias" name="caixas_vazias" value="0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="quantidade_caixas" class="form-label">Quantidade de Caixas</label>
                            <input type="number" class="form-control" id="quantidade_caixas" name="quantidade_caixas" value="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="valor_km" class="form-label">Valor por KM</label>
                            <input type="number" step="0.01" class="form-control" id="valor_km" name="valor_km">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="valor_frete" class="form-label">Valor do Frete</label>
                            <input type="number" step="0.01" class="form-control" id="valor_frete" name="valor_frete" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="status_frete" class="form-label">Status do Frete</label>
                            <select class="form-select" id="status_frete" name="status_frete">
                                <option value="A_PAGAR">A pagar</option>
                                <option value="PAGO">Pago</option>
                                <option value="INCLUSO">Incluso</option>
                                <option value="CANCELADO">Cancelado</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Informações do Produtor e Documentação -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Informações do Produtor e Documentação</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="produtor" class="form-label">Produtor</label>
                            <select class="form-select" id="produtor" name="produtor" required>
                                <option value="">Selecione um produtor</option>
                                {% for produtor in produtores %}
                                <option value="{{ produtor }}">{{ produtor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="uf_produtor" class="form-label">UF do Produtor</label>
                            <select class="form-select" id="uf_produtor">
                                <option value="">Selecione...</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amapá</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Ceará</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Espírito Santo</option>
                                <option value="GO">Goiás</option>
                                <option value="MA">Maranhão</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Pará</option>
                                <option value="PB">Paraíba</option>
                                <option value="PR">Paraná</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piauí</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rondônia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">São Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="numero_nfe" class="form-label">Número da NFe</label>
                            <input type="text" class="form-control" id="numero_nfe">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="data_nfe" class="form-label">Data da NFe</label>
                            <input type="date" class="form-control" id="data_nfe">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="numero_gta" class="form-label">Número da GTA</label>
                            <input type="text" class="form-control" id="numero_gta">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="data_gta" class="form-label">Data da GTA</label>
                            <input type="date" class="form-control" id="data_gta">
                        </div>
                    </div>
                </div>

                <!-- Botão para adicionar subcarga -->
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="button" class="btn btn-secondary" id="btnAddSubcarga">
                            <i class="fas fa-plus"></i> Adicionar Subcarga
                        </button>
                    </div>
                </div>

                <!-- Container para subcargas -->
                <div id="subcargas-container">
                    <!-- As subcargas serão adicionadas aqui dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Informações de Peso -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Informações de Peso</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="peso_granja" class="form-label">Peso na Granja (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="peso_granja">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="peso_frigorifico" class="form-label">Peso no Frigorífico (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="peso_frigorifico">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="percentual_quebra" class="form-label">Percentual de Quebra (%)</label>
                            <input type="number" step="0.01" class="form-control" id="percentual_quebra" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="quebra_peso" class="form-label">Quebra de Peso (kg)</label>
                            <input type="number" step="0.01" class="form-control" id="quebra_peso" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3" id="div_motivo_quebra" style="display: none;">
                            <label for="motivo_alta_quebra" class="form-label">Motivo da Alta Quebra</label>
                            <textarea class="form-control" id="motivo_alta_quebra" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fechamento de Transporte -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Fechamento de Transporte</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="valor_frete_fechamento" class="form-label">Valor do Frete</label>
                            <input type="number" step="0.01" class="form-control" id="valor_frete_fechamento" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="pedagios" class="form-label">Pedágios</label>
                            <input type="number" step="0.01" class="form-control" id="pedagios" value="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="outras_despesas" class="form-label">Outras Despesas</label>
                            <input type="number" step="0.01" class="form-control" id="outras_despesas" value="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="abastecimento_empresa" class="form-label">Abastecimento na Empresa</label>
                            <input type="number" step="0.01" class="form-control" id="abastecimento_empresa" value="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="abastecimento_posto" class="form-label">Abastecimento em Posto</label>
                            <input type="number" step="0.01" class="form-control" id="abastecimento_posto" value="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="adiantamento" class="form-label">Adiantamento</label>
                            <input type="number" step="0.01" class="form-control" id="adiantamento" value="0">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="valor_pagar" class="form-label">Valor a Pagar</label>
                            <input type="number" step="0.01" class="form-control" id="valor_pagar" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="row mt-4 mb-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary" id="btnSalvarCarga">Salvar Carga</button>
                <button type="button" class="btn btn-secondary" id="btnSalvarRascunho">Salvar Rascunho</button>
                <button type="button" class="btn btn-danger" id="btnLimparCargas">Limpar</button>
            </div>
        </div>
    </form>
</div>

<!-- Template para Subcargas -->
<template id="template-subcarga">
    <div class="subcarga-item border rounded p-3 mt-3">
        <h5 class="mb-3">Subcarga <span class="numero-subcarga"></span></h5>
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Tipo de Ave</label>
                    <select class="form-select subcarga-tipo-ave">
                        <option value="">Selecione...</option>
                        <option value="Frango">Frango</option>
                        <option value="Galinha Leve">Galinha Leve</option>
                        <option value="Galinha Matriz">Galinha Matriz</option>
                        <option value="Galinha Vermelha">Galinha Vermelha</option>
                        <option value="Galo">Galo</option>
                    </select>
                </div>
            </div>
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label">Produtor</label>
                    <select class="form-select subcarga-produtor">
                        <option value="">Selecione um produtor</option>
                        {% for produtor in produtores %}
                        <option value="{{ produtor }}">{{ produtor }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">UF do Produtor</label>
                    <select class="form-select subcarga-uf">
                        <option value="">Selecione...</option>
                        <option value="AC">Acre</option>
                        <option value="AL">Alagoas</option>
                        <option value="AP">Amapá</option>
                        <option value="AM">Amazonas</option>
                        <option value="BA">Bahia</option>
                        <option value="CE">Ceará</option>
                        <option value="DF">Distrito Federal</option>
                        <option value="ES">Espírito Santo</option>
                        <option value="GO">Goiás</option>
                        <option value="MA">Maranhão</option>
                        <option value="MT">Mato Grosso</option>
                        <option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option>
                        <option value="PA">Pará</option>
                        <option value="PB">Paraíba</option>
                        <option value="PR">Paraná</option>
                        <option value="PE">Pernambuco</option>
                        <option value="PI">Piauí</option>
                        <option value="RJ">Rio de Janeiro</option>
                        <option value="RN">Rio Grande do Norte</option>
                        <option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rondônia</option>
                        <option value="RR">Roraima</option>
                        <option value="SC">Santa Catarina</option>
                        <option value="SP">São Paulo</option>
                        <option value="SE">Sergipe</option>
                        <option value="TO">Tocantins</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Número NFe</label>
                    <input type="text" class="form-control subcarga-nfe">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Data NFe</label>
                    <input type="date" class="form-control subcarga-data-nfe">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Número GTA</label>
                    <input type="text" class="form-control subcarga-gta">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Data GTA</label>
                    <input type="date" class="form-control subcarga-data-gta">
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-danger btn-remover-subcarga">
            <i class="fas fa-trash"></i> Remover Subcarga
        </button>
    </div>
</template>

{% endblock content %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Funções de cálculo
    function calcularQuebraPeso() {
        const pesoGranja = parseFloat($('#peso_granja').val()) || 0;
        const pesoFrigorifico = parseFloat($('#peso_frigorifico').val()) || 0;
        
        if (pesoGranja > 0 && pesoFrigorifico > 0) {
            const quebraPeso = pesoGranja - pesoFrigorifico;
            const percentualQuebra = ((quebraPeso / pesoGranja) * 100);
            
            $('#quebra_peso').val(quebraPeso.toFixed(2));
            $('#percentual_quebra').val(percentualQuebra.toFixed(2));
            
            if (percentualQuebra > 5) {
                $('#div_motivo_quebra').show();
                $('#motivo_alta_quebra').prop('required', true);
            } else {
                $('#div_motivo_quebra').hide();
                $('#motivo_alta_quebra').prop('required', false);
                $('#motivo_alta_quebra').val('');
            }
        }
    }

    function calcularKmRodados() {
        const kmSaida = parseFloat($('#km_saida').val()) || 0;
        const kmChegada = parseFloat($('#km_chegada').val()) || 0;
        
        if (kmChegada >= kmSaida) {
            const kmRodados = kmChegada - kmSaida;
            $('#km_rodados').val(kmRodados.toFixed(2));
            calcularValorFrete();
        } else {
            $('#km_rodados').val('');
            $('#valor_frete').val('');
            $('#valor_frete_fechamento').val('');
            $('#valor_pagar').val('');
        }
    }

    function calcularValorFrete() {
        const kmRodados = parseFloat($('#km_rodados').val()) || 0;
        const valorKm = parseFloat($('#valor_km').val()) || 0;
        
        if (kmRodados > 0 && valorKm > 0) {
            const valorFrete = kmRodados * valorKm;
            $('#valor_frete').val(valorFrete.toFixed(2));
            $('#valor_frete_fechamento').val(valorFrete.toFixed(2));
            calcularValorPagar();
        }
    }

    function calcularValorPagar() {
        const valorFrete = parseFloat($('#valor_frete').val()) || 0;
        const pedagios = parseFloat($('#pedagios').val()) || 0;
        const outrasDespesas = parseFloat($('#outras_despesas').val()) || 0;
        const abastecimentoEmpresa = parseFloat($('#abastecimento_empresa').val()) || 0;
        const abastecimentoPosto = parseFloat($('#abastecimento_posto').val()) || 0;
        const adiantamento = parseFloat($('#adiantamento').val()) || 0;

        const valorPagar = valorFrete + pedagios + outrasDespesas - abastecimentoEmpresa - abastecimentoPosto - adiantamento;
        $('#valor_pagar').val(valorPagar.toFixed(2));
    }

    // Funções de interface
    function atualizarDiaSemana() {
        const dataAbate = $('#data_abate').val();
        console.log('Data original:', dataAbate);
        
        if (dataAbate) {
            let data;
            
            // Verifica se a data está no formato yyyy-mm-dd (formato do input type="date")
            if (dataAbate.includes('-')) {
                data = new Date(dataAbate + 'T00:00:00');
            } else {
                // Se estiver no formato dd/mm/yyyy
                const [dia, mes, ano] = dataAbate.split('/');
                data = new Date(`${ano}-${mes}-${dia}T00:00:00`);
            }
            
            console.log('Data parseada:', data);
            
            const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            const diaSemana = diasSemana[data.getDay()];
            console.log('Dia da semana:', diaSemana);
            
            $('#dia_semana').val(diaSemana);
        } else {
            $('#dia_semana').val('');
        }
    }

    function toggleOutroMotorista() {
        if ($('#motorista').val() === 'outro') {
            $('#outro-motorista-div').show();
            $('#motorista_outro').prop('required', true);
        } else {
            $('#outro-motorista-div').hide();
            $('#motorista_outro').prop('required', false);
            $('#motorista_outro').val('');
        }
    }

    // Objeto com os valores por placa
    const valoresPorPlaca = {
        'AZT-7A23': '6.00',
        'HMV-9126': '6.00',
        'MYY-8770': '6.00',
        'OGB-9I64': '6.20',
        'PAM-9J75': '6.00',
        'PIW-6G46': '6.20',
        'QKC-1E87': '6.00',
        'RCY-3D00': '6.20',
        'RLS-3A83': '6.20',
        'RLV-0F19': '6.20',
        'SKP-4J09': '6.20'
    };

    function atualizarValorKm(placa) {
        console.log('Atualizando valor para placa:', placa);
        if (placa === 'outra') {
            $('#placa_veiculo_input').show();
            $('#valor_km').prop('readonly', false).val('');
        } else {
            const valor = valoresPorPlaca[placa];
            console.log('Valor encontrado:', valor);
            if (valor) {
                $('#valor_km').val(valor);
                $('#placa_veiculo_input').hide();
                $('#valor_km').prop('readonly', true);
                calcularValorFrete();
            }
        }
    }

    function togglePlacaVeiculo() {
        const transportadora = $('#transportadora').val();
        console.log('Transportadora selecionada:', transportadora);
        
        if (transportadora === 'Ellen Transportes') {
            $('#placa_veiculo').show();
            $('#placa_veiculo_input').hide().val('');
            $('#valor_km').prop('readonly', true);
            
            // Atualizar valor quando a placa for selecionada
            $('#placa_veiculo').off('change').on('change', function() {
                const placa = $(this).val();
                console.log('Placa selecionada:', placa);
                atualizarValorKm(placa);
            });

            // Se já houver uma placa selecionada, atualizar o valor
            const placaAtual = $('#placa_veiculo').val();
            if (placaAtual) {
                console.log('Placa já selecionada:', placaAtual);
                atualizarValorKm(placaAtual);
            }
        } else if (transportadora === 'Terceirizado') {
            $('#placa_veiculo').hide().val('');
            $('#placa_veiculo_input').show();
            $('#valor_km').prop('readonly', false).val('');
            $('#placa_veiculo').off('change');
        } else {
            $('#placa_veiculo').hide().val('');
            $('#placa_veiculo_input').hide().val('');
            $('#valor_km').prop('readonly', false).val('');
            $('#placa_veiculo').off('change');
        }
        calcularValorFrete();
    }

    // Variáveis para subcargas
    let contadorSubcargas = 0;
    const MAX_SUBCARGAS = 2;

    function adicionarSubcarga() {
        console.log('Tentando adicionar subcarga...');
        if (contadorSubcargas >= MAX_SUBCARGAS) {
            Swal.fire({
                icon: 'warning',
                title: 'Limite atingido',
                text: 'Máximo de ' + MAX_SUBCARGAS + ' subcargas permitido.'
            });
            return;
        }

        // Clonar o template
        const template = document.querySelector('#template-subcarga');
        if (!template) {
            console.error('Template de subcarga não encontrado!');
            return;
        }

        contadorSubcargas++;
        console.log('Adicionando subcarga número:', contadorSubcargas);

        const novaSubcarga = document.importNode(template.content, true);
        console.log('Template clonado:', novaSubcarga);

        // Atualizar o número da subcarga
        const numeroSpan = novaSubcarga.querySelector('.numero-subcarga');
        if (numeroSpan) {
            numeroSpan.textContent = contadorSubcargas;
        }

        // Adicionar ao container
        const container = document.getElementById('subcargas-container');
        if (container) {
            container.appendChild(novaSubcarga);
            console.log('Subcarga adicionada ao container');

            // Configurar botão de remover
            const btnRemover = container.querySelector('.subcarga-item:last-child .btn-remover-subcarga');
            if (btnRemover) {
                btnRemover.addEventListener('click', function() {
                    this.closest('.subcarga-item').remove();
                    contadorSubcargas--;
                    document.getElementById('btnAddSubcarga').disabled = false;
                    
                    // Atualizar números das subcargas restantes
                    document.querySelectorAll('.subcarga-item').forEach((item, index) => {
                        item.querySelector('.numero-subcarga').textContent = index + 1;
                    });
                });
            }

            // Desabilitar botão se atingiu o limite
            if (contadorSubcargas >= MAX_SUBCARGAS) {
                document.getElementById('btnAddSubcarga').disabled = true;
            }
        } else {
            console.error('Container de subcargas não encontrado!');
        }
    }

    function coletarDadosSubcargas() {
        const subcargas = [];
        $('.subcarga-item').each(function() {
            const subcarga = {
                tipo_ave: $(this).find('.subcarga-tipo-ave').val(),
                produtor: $(this).find('.subcarga-produtor').val(),
                uf_produtor: $(this).find('.subcarga-uf').val(),
                numero_nfe: $(this).find('.subcarga-nfe').val(),
                data_nfe: $(this).find('.subcarga-data-nfe').val(),
                numero_gta: $(this).find('.subcarga-gta').val(),
                data_gta: $(this).find('.subcarga-data-gta').val()
            };
            subcargas.push(subcarga);
        });
        return subcargas;
    }

    function salvarCarga(e) {
        e.preventDefault();
        
        // Coletar dados do formulário
        const dadosCarga = {
            tipo_ave: $('#tipo_ave').val(),
            quantidade_cargas: $('#quantidade_cargas').val(),
            ordem_carga: $('#ordem_carga').val(),
            data_abate: $('#data_abate').val(),
            dia_semana: $('#dia_semana').val(),
            agenciador: $('#agenciador').val(),
            motorista: $('#motorista').val() === 'outro' ? $('#motorista_outro').val() : $('#motorista').val(),
            transportadora: $('#transportadora').val(),
            placa_veiculo: $('#transportadora').val() === 'Ellen Transportes' ? $('#placa_veiculo').val() : $('#placa_veiculo_input').val(),
            km_saida: $('#km_saida').val(),
            km_chegada: $('#km_chegada').val(),
            km_rodados: $('#km_rodados').val(),
            valor_km: $('#valor_km').val(),
            valor_frete: $('#valor_frete').val(),
            status_frete: $('#status_frete').val(),
            caixas_vazias: $('#caixas_vazias').val(),
            quantidade_caixas: $('#quantidade_caixas').val(),
            pedagios: $('#pedagios').val(),
            outras_despesas: $('#outras_despesas').val(),
            abastecimento_empresa: $('#abastecimento_empresa').val(),
            abastecimento_posto: $('#abastecimento_posto').val(),
            adiantamento: $('#adiantamento').val(),
            valor_pagar: $('#valor_pagar').val(),
            // Adicionar campos de peso e quebra
            peso_granja: $('#peso_granja').val(),
            peso_frigorifico: $('#peso_frigorifico').val(),
            percentual_quebra: $('#percentual_quebra').val(),
            quebra_peso: $('#quebra_peso').val(),
            motivo_alta_quebra: $('#motivo_alta_quebra').val(),
            // Adicionar campos do produtor
            produtor: $('#produtor').val(),
            uf_produtor: $('#uf_produtor').val(),
            numero_nfe: $('#numero_nfe').val(),
            data_nfe: $('#data_nfe').val(),
            numero_gta: $('#numero_gta').val(),
            data_gta: $('#data_gta').val(),
            subcargas: coletarDadosSubcargas()
        };

        // Enviar dados para o servidor
        $.ajax({
            url: '/cargas/criar_carga',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dadosCarga),
            success: function(response) {
                if (response.success) {
                    // Atualizar o número da carga no formulário
                    $('#numero_carga').val(response.numero_carga);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso',
                        text: response.message,
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = '/cargas';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: response.message || 'Erro ao salvar a carga'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao salvar a carga: ' + (xhr.responseJSON?.message || 'Erro desconhecido')
                });
            }
        });
    }

    // Event listeners
    $('#data_abate').on('change input', atualizarDiaSemana);
    $('#motorista').on('change', toggleOutroMotorista);
    $('#transportadora').on('change', togglePlacaVeiculo);
    $('#placa_veiculo').on('change', function() {
        atualizarValorKm($(this).val());
    });
    $('#placa_veiculo_input').on('input', function() {
        atualizarValorKm($(this).val());
    });
    
    // Event listeners para cálculos de peso e quebra
    $('#peso_granja, #peso_frigorifico').on('change input', calcularQuebraPeso);
    
    // Event listeners para cálculos financeiros
    $('#km_saida, #km_chegada').on('change input', calcularKmRodados);
    $('#km_rodados, #valor_km').on('change input', calcularValorFrete);
    $('#valor_frete, #pedagios, #outras_despesas, #abastecimento_empresa, #abastecimento_posto, #adiantamento').on('change input', calcularValorPagar);
    $('#btnAddSubcarga').on('click', function(e) {
        e.preventDefault();
        adicionarSubcarga();
    });
    $('#btnSalvarCarga').on('click', salvarCarga);

    // Inicialização
    if ($('#data_abate').val()) {
        atualizarDiaSemana();
    }
    if ($('#motorista').val() === 'outro') {
        toggleOutroMotorista();
    }
    if ($('#transportadora').val()) {
        togglePlacaVeiculo();
    }

    // Carregar o próximo número de carga
    $.get('/cargas/proximo_numero', function(response) {
        if (response.numero) {
            $('#numero_carga').val(response.numero);
        }
    });

    // Log para debug
    console.log('Script inicializado');
    console.log('jQuery versão:', $.fn.jquery);
});
</script>
{% endblock scripts %}